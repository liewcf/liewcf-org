---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Contact" description="Send a message to Liew CheonFong" showHeader={false}>
	<article class="mb-16 sm:mb-24">
		<header class="mb-8">
			<h1 class="font-serif text-3xl leading-tight font-medium sm:text-5xl sm:leading-tight">
				Contact
			</h1>
			<p class="mt-4 text-sm sm:text-base">
				Send a message and Iâ€™ll get back to you.
			</p>
		</header>

		<form id="contact-form" class="flex max-w-xl flex-col gap-6">
			<div class="flex flex-col gap-2">
				<label class="font-serif" for="name">Name</label>
				<input
					id="name"
					name="name"
					type="text"
					autocomplete="name"
					required
					class="border-main text-main placeholder:text-main/60 h-10 rounded-full border border-dashed bg-transparent px-5 text-sm focus:outline-hidden"
				/>
			</div>
			<div class="flex flex-col gap-2">
				<label class="font-serif" for="email">Email</label>
				<input
					id="email"
					name="email"
					type="email"
					autocomplete="email"
					required
					class="border-main text-main placeholder:text-main/60 h-10 rounded-full border border-dashed bg-transparent px-5 text-sm focus:outline-hidden"
				/>
			</div>
			<div class="flex flex-col gap-2">
				<label class="font-serif" for="subject">Subject</label>
				<input
					id="subject"
					name="subject"
					type="text"
					required
					class="border-main text-main placeholder:text-main/60 h-10 rounded-full border border-dashed bg-transparent px-5 text-sm focus:outline-hidden"
				/>
			</div>
			<div class="flex flex-col gap-2">
				<label class="font-serif" for="message">Message</label>
				<textarea
					id="message"
					name="message"
					rows="6"
					required
					class="border-main text-main placeholder:text-main/60 min-h-40 rounded-3xl border border-dashed bg-transparent px-5 py-3 text-sm focus:outline-hidden"
				/>
			</div>

			<input class="hidden" name="company" type="text" tabindex="-1" autocomplete="off" />

			<div>
				<div
					id="turnstile-container"
					class="cf-turnstile"
					data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY}
				/>
			</div>

			<div class="flex flex-col gap-3">
				<button
					type="submit"
					class="border-main inline-flex h-10 w-fit items-center justify-center rounded-full border border-dashed px-6 text-sm font-medium"
				>
					Send Message
				</button>
				<p id="form-status" class="text-sm" aria-live="polite"></p>
			</div>
		</form>
	</article>

		<script is:inline>
			const TURNSTILE_SRC = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
			const RATE_LIMIT_KEY = 'contact_submissions';
			const RATE_LIMIT_MAX = 5;
			const RATE_LIMIT_WINDOW_MS = 60 * 60 * 1000; // 1 hour

			let turnstileToken = '';
			let turnstileWidgetId = null;

			const checkRateLimit = () => {
				try {
					const stored = localStorage.getItem(RATE_LIMIT_KEY);
					const now = Date.now();
					const windowStart = now - RATE_LIMIT_WINDOW_MS;
					const submissions = stored ? JSON.parse(stored) : [];
					const validSubmissions = submissions.filter((ts) => ts > windowStart);

					if (validSubmissions.length >= RATE_LIMIT_MAX) {
						const oldestValid = validSubmissions[0];
						const waitMinutes = Math.ceil((oldestValid + RATE_LIMIT_WINDOW_MS - now) / 60000);
						return { allowed: false, waitMinutes };
					}

					return { allowed: true, validSubmissions };
				} catch (e) {
					return { allowed: true, validSubmissions: [] };
				}
			};

			const recordSubmission = () => {
				try {
					const { validSubmissions } = checkRateLimit();
					validSubmissions.push(Date.now());
					localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(validSubmissions));
				} catch (e) {
					// Ignore localStorage errors
				}
			};

			const hasTurnstileApi = () => Boolean(window.turnstile && typeof window.turnstile.render === 'function');

			const ensureTurnstileLoaded = () => {
				if (hasTurnstileApi()) return Promise.resolve();

				return new Promise((resolve, reject) => {
					const existing = document.querySelector(`script[src="${TURNSTILE_SRC}"]`);
					if (existing) {
						existing.addEventListener('load', () => resolve());
					existing.addEventListener('error', () => reject());
					return;
				}

				const script = document.createElement('script');
				script.src = TURNSTILE_SRC;
				script.async = true;
				script.defer = true;
				script.addEventListener('load', () => resolve());
				script.addEventListener('error', () => reject());
				document.head.appendChild(script);
			});
			};

			const initTurnstile = async () => {
				const container = document.getElementById('turnstile-container');
				if (!(container instanceof HTMLElement)) return;
				if (container.dataset.rendered === 'true') return;

				try {
					await ensureTurnstileLoaded();
				} catch (error) {
					return;
				}

				const sitekey = container.getAttribute('data-sitekey') || '';
				if (!sitekey) return;
				if (!hasTurnstileApi()) return;

				turnstileWidgetId = window.turnstile.render(container, {
					sitekey,
					callback: (token) => {
						turnstileToken = String(token || '');
				},
				'expired-callback': () => {
					turnstileToken = '';
				},
				'error-callback': () => {
					turnstileToken = '';
				},
			});
			container.dataset.rendered = 'true';
		};

		const attachContactHandler = () => {
			const form = document.getElementById('contact-form');
			const status = document.getElementById('form-status');
			if (!(form instanceof HTMLFormElement) || !(status instanceof HTMLElement)) return;
			if (form.dataset.bound === 'true') return;
			form.dataset.bound = 'true';

			form.addEventListener('submit', async (event) => {
				event.preventDefault();

				const rateCheck = checkRateLimit();
				if (!rateCheck.allowed) {
					status.textContent = `Too many messages sent. Please try again in ${rateCheck.waitMinutes} minute(s).`;
					return;
				}

				status.textContent = 'Sending...';

				const formData = new FormData(form);
				const existingToken = String(formData.get('cf-turnstile-response') || '').trim();
				if (!existingToken && turnstileToken) {
					formData.set('cf-turnstile-response', turnstileToken);
				}

				const finalToken = String(formData.get('cf-turnstile-response') || '').trim();
				if (!finalToken) {
					status.textContent = 'Please complete the Turnstile challenge and try again.';
					return;
				}

				try {
					const response = await fetch('/api/contact', {
						method: 'POST',
						body: formData,
					});
					const result = await response.json().catch(() => ({}));

					if (response.ok) {
						status.textContent = 'Thanks! Your message has been sent.';
						recordSubmission();
						form.reset();
						turnstileToken = '';
						if (window.turnstile && turnstileWidgetId !== null) window.turnstile.reset(turnstileWidgetId);
					} else {
						status.textContent = result?.error ?? 'Something went wrong. Please try again.';
						if (String(result?.error || '').toLowerCase().includes('turnstile')) {
							turnstileToken = '';
							if (window.turnstile && turnstileWidgetId !== null) window.turnstile.reset(turnstileWidgetId);
						}
					}
				} catch (error) {
					status.textContent = 'Unable to send right now. Please try again later.';
				}
			});
		};

		document.addEventListener('astro:page-load', () => {
			initTurnstile();
			attachContactHandler();
		});
	</script>
</BaseLayout>
