---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Contact" description="Send a message to Liew CheonFong" showHeader={false}>
	<article class="mb-16 sm:mb-24">
		<header class="mb-8">
			<h1 class="font-serif text-3xl leading-tight font-medium sm:text-5xl sm:leading-tight">
				Contact
			</h1>
			<p class="mt-4 text-sm sm:text-base">
				Send a message and Iâ€™ll get back to you.
			</p>
		</header>

		<form id="contact-form" class="flex max-w-xl flex-col gap-6">
			<div class="flex flex-col gap-2">
				<label class="font-serif" for="name">Name</label>
				<input
					id="name"
					name="name"
					type="text"
					autocomplete="name"
					required
					class="border-main text-main placeholder:text-main/60 h-10 rounded-full border border-dashed bg-transparent px-5 text-sm focus:outline-hidden"
				/>
			</div>
			<div class="flex flex-col gap-2">
				<label class="font-serif" for="email">Email</label>
				<input
					id="email"
					name="email"
					type="email"
					autocomplete="email"
					required
					class="border-main text-main placeholder:text-main/60 h-10 rounded-full border border-dashed bg-transparent px-5 text-sm focus:outline-hidden"
				/>
			</div>
			<div class="flex flex-col gap-2">
				<label class="font-serif" for="subject">Subject</label>
				<input
					id="subject"
					name="subject"
					type="text"
					required
					class="border-main text-main placeholder:text-main/60 h-10 rounded-full border border-dashed bg-transparent px-5 text-sm focus:outline-hidden"
				/>
			</div>
			<div class="flex flex-col gap-2">
				<label class="font-serif" for="message">Message</label>
				<textarea
					id="message"
					name="message"
					rows="6"
					required
					class="border-main text-main placeholder:text-main/60 min-h-40 rounded-3xl border border-dashed bg-transparent px-5 py-3 text-sm focus:outline-hidden"
				/>
			</div>

			<input class="hidden" name="company" type="text" tabindex="-1" autocomplete="off" />

			<div>
				<div
					id="turnstile"
					class="cf-turnstile"
					data-sitekey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY}
				/>
			</div>

			<div class="flex flex-col gap-3">
				<button
					type="submit"
					class="border-main inline-flex h-10 w-fit items-center justify-center rounded-full border border-dashed px-6 text-sm font-medium"
				>
					Send Message
				</button>
				<p id="form-status" class="text-sm" aria-live="polite"></p>
			</div>
		</form>
	</article>

	<script is:inline>
		const TURNSTILE_SRC = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';

		const ensureTurnstileLoaded = () => {
			if (window.turnstile) return Promise.resolve();

			return new Promise((resolve, reject) => {
				const existing = document.querySelector(`script[src="${TURNSTILE_SRC}"]`);
				if (existing) {
					existing.addEventListener('load', () => resolve());
					existing.addEventListener('error', () => reject());
					return;
				}

				const script = document.createElement('script');
				script.src = TURNSTILE_SRC;
				script.async = true;
				script.defer = true;
				script.addEventListener('load', () => resolve());
				script.addEventListener('error', () => reject());
				document.head.appendChild(script);
			});
		};

		const initTurnstile = async () => {
			const container = document.getElementById('turnstile');
			if (!(container instanceof HTMLElement)) return;
			if (container.dataset.rendered === 'true') return;

			try {
				await ensureTurnstileLoaded();
			} catch (error) {
				return;
			}

			const sitekey = container.getAttribute('data-sitekey') || '';
			if (!sitekey) return;
			if (!window.turnstile?.render) return;

			window.turnstile.render(container, { sitekey });
			container.dataset.rendered = 'true';
		};

		const attachContactHandler = () => {
			const form = document.getElementById('contact-form');
			const status = document.getElementById('form-status');
			if (!(form instanceof HTMLFormElement) || !(status instanceof HTMLElement)) return;
			if (form.dataset.bound === 'true') return;
			form.dataset.bound = 'true';

			form.addEventListener('submit', async (event) => {
				event.preventDefault();
				status.textContent = 'Sending...';

				const formData = new FormData(form);
				try {
					const response = await fetch('/api/contact', {
						method: 'POST',
						body: formData,
					});
					const result = await response.json().catch(() => ({}));

					if (response.ok) {
						status.textContent = 'Thanks! Your message has been sent.';
						form.reset();
						if (window.turnstile) {
							window.turnstile.reset();
						}
					} else {
						status.textContent = result?.error ?? 'Something went wrong. Please try again.';
					}
				} catch (error) {
					status.textContent = 'Unable to send right now. Please try again later.';
				}
			});
		};

		document.addEventListener('astro:page-load', () => {
			initTurnstile();
			attachContactHandler();
		});
	</script>
</BaseLayout>
